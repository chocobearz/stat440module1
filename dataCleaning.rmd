---
title: "Module1"
author: "Paige Tuttosi"
date: "25/09/2020"
output: html_document
---

```{r}
source('range_to_mean.R')
source('words_split.R')
library(ggplot2)
library(stringr)
library(purrr)
library(dplyr)
```

```{r}
# Load in the new training data
train <- read.csv("data/train2.txt")
```


```{r, eval = F}
summary(train)
str(train)
```

```{r}
# Clean age ranges by converting age ranges to a single number
train$clean_age <- map_dbl(train$age, range_to_mean)
summary(train)
str(train)
```


Plots of duration vs. clean_age with colors for the other variables
```{r, eval = F}
ggplot(train, aes(x=clean_age, y=duration, color=sex)) +
  geom_point()
ggplot(train, aes(x=clean_age, y=duration, color=city)) +
  geom_point()
ggplot(train, aes(x=clean_age, y=duration, color=country)) +
  geom_point()
ggplot(train, aes(x=clean_age, y=duration, color=province)) +
  geom_point()
ggplot(train, aes(x=clean_age, y=duration, color=V1)) +
  geom_point()
ggplot(train, aes(x=clean_age, y=duration, color=outcome)) +
  geom_point()
```

Clean symptoms
```{r}
# Create a vector of symptoms, with each element corresponding to a symptom
words1 <- words_split(train1$symptoms, sep = "; ")

# Looking at the frequencies of the symptoms
sort(table(words1), decreasing = T)

# Get the unique symptoms
words2 <- words1 %>%
  unique() %>%
  # Replace the "℃" with "C"
  str_replace_all("℃", "C") %>%
  # Replace " ° " with " "
  str_replace_all(" ° ", " ")

# Initialize a dataframe
symptoms_df <- data.frame(matrix(nrow = nrow(train),
                                 ncol = length(words2)))
# Create column names from the unique symptoms
colnames(symptoms_df) <- words2

# Create the vectors for the columns
for( i in c( 1:length(words2) ) ){
  # Each column indicates if the word is present in the symptoms column
  symptoms_df[ , i] <- str_detect(train$symptoms, words2[i])
}

# Combine the original train data frame with the new symptoms data frame
train_full <- cbind(train, symptoms_df)
```

Dataframe cleaning function
```{r}
clean_age_and_symptoms <- function(df1){
  # This function just applies all of the cleaning steps to the
  # Stat 440 module 1 covid data sets. The function accepts a dataframe
  # and outputs the cleaned dataframe.
  library(purrr)
  library(dplyr)
  library(stringr)
  source('range_to_mean.R')
  source('words_split.R')
  # Clean age ranges by converting age ranges to a single number
  df1$clean_age <- map_dbl(df1$age, range_to_mean)
  
  # Create a vector of symptoms, with each element corresponding
  # to a symptom
  words1 <- words_split(df1$symptoms, sep = "; ")
  
  # Get the unique symptoms
  words2 <- words1 %>%
    unique() %>%
    # Replace the "℃" with "C"
    str_replace_all("℃", "C") %>%
    # Replace " ° " with " "
    str_replace_all(" ° ", " ")
  
  # Initialize a dataframe
  symptoms_df <- data.frame(
    matrix(nrow = nrow(df1),
           ncol = length(words2))
    )
  # Create column names from the unique symptoms
  colnames(symptoms_df) <- words2
  
  # Create the vectors for the columns
  for( i in c( 1:length(words2) ) ){
    # Each column indicates if the word is present in the symptoms column
    symptoms_df[ , i] <- str_detect(df1$symptoms, words2[i])
  }
  # Combine the original train data frame with the new symptoms data frame
  df1 <- cbind(df1, symptoms_df)
  
  # Remove the intermediate variables
  rm(symptoms_df, words1, words2)
  
  # Return the new dataframe
  return(df1)
}
```

Clean the test data set
```{r}
test2 <- read.csv("data/test2.txt")

test2 <- clean_age_and_symptoms(test2)

test2$age <- NULL
test2$symptoms <- NULL
test2$confirmed <- NULL

# Export the new test dataset
write.csv(test2, "test2_cleaned.csv")

# Consideration: the new test data set might have indicator symptom
# variables that aren't present in even the other three data sets.
```


Clean the other data sets
```{r}
# Old training set
train1 <- read.csv("data/train.txt")
# Remove the "outcome" column for merging purposes
train1$outcome <- NULL

# Old test set that had durations
test1 <- read.csv("data/test.txt")
# Remove the Id column for mergin purposes
test1$Id <- NULL

# Copying the new training set
train_new <- read.csv("data/train2.txt")
# Remove the "outcome" column for merging purposes
train_new$outcome <- NULL

# Merge the data sets
merged_df1 <- rbind(train1, test1, train_new)

# Remove the date columns too; we should use them once they've been cleaned
# into a date variable so that we can use it as a numerical category for
# the fast.ai model
# Note that the fast.ai tabular model only accepts categorical or numerical
# variables.
merged_df1$confirmed <- NULL

# Clean the df
merged_df1 <- clean_age_and_symptoms(merged_df1)

# Consideration: Not sure what to do with the outcome column in the
# old test set; not sure if they are actually all blank or missing

train_new <- clean_age_and_symptoms(train_new)
train_new$confirmed <- NULL
```

Exporting to Python
```{r}
# Export the merged data sets that all have duration
write.csv(merged_df1, "data/merged_df1.csv")

# Export just the new training set
write.csv(train_new, "data/train_new_cleaned.csv")
```









